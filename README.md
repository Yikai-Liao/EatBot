# 食堂预约机器人

## 1. 项目目标
- 基于飞书机器人和飞书多维表格，实现工作日自动发起食堂预约。
- 用户通过消息卡片按钮选择餐次，系统自动写入和更新用餐记录。
- 在每餐预约截止后自动发送统计结果给指定接收人。

## 2. 业务范围与约束
- 数据存储：仅使用飞书多维表格，不使用本地数据库。
- 运行方式：Python + uv。
- 网络约束：不依赖固定公网 IP。
- 配置原则：不在配置中固定 field_id，通过字段名动态匹配 field_id，私密配置与共享配置分离（`config.local.toml` / `config.shared.toml`）。

## 3. 业务规则（条理化）
### 3.1 每日预约卡片发送
- 在配置日期内，每天固定时间向启用用户发送预约卡片。
- 卡片提供三个按钮：午餐、晚餐、刷新。
- 点击按钮即切换对应餐次的选中状态，并立即回写记录与刷新卡片高亮状态。
- 点击“刷新”会重新读取当日记录并同步按钮高亮，不会修改表格。
- 默认推荐来源于“用餐人员配置”表中的“餐食偏好”。

### 3.2 记录创建与更新
- 发卡后按默认偏好写入“用餐记录”。
- 发卡时按钮状态优先以“用餐记录”中的当日已有记录为准；仅当无记录时才回落到默认偏好。
- 用户点击卡片按钮后，按最终选择更新“用餐记录”。
- 若取消则更新该餐对应记录的“预约状态”为未勾选。
- 不写“用餐人员配置”表（偏好表只由管理员维护）。

### 3.3 截止时间控制
- 每天在配置截止时间后，不允许修改卡片状态。
- 若单卡无法对午晚餐分别控制可编辑状态，则拆分为两张卡片发送。

### 3.4 餐次统计发送
- 每顿饭截止后，统计该餐用餐人数。
- 给“统计信息接收人员”表中的人员发送统计消息。

### 3.5 日期选择优先级
- 默认规则：仅周一到周五发送，周末不发。
- 覆盖规则：以“用餐定时配置”表为最高优先级。
- 当命中开始/结束日期闭区间时，以“当日餐食包含”决定是否发卡和发哪一餐。

## 4. 数据表与字段
## 4.1 表链接
- 用餐人员配置：https://ycnw20znloxr.feishu.cn/wiki/QC07wNez9iSgZhk6rg7cOW2PnNb?table=tblrulMIAx0vnkHu&view=vewIkQTtpb
- 用餐定时配置：https://ycnw20znloxr.feishu.cn/wiki/QC07wNez9iSgZhk6rg7cOW2PnNb?table=tblUONtouxmxvVFq&view=vewaTe1QWZ
- 用餐记录：https://ycnw20znloxr.feishu.cn/wiki/QC07wNez9iSgZhk6rg7cOW2PnNb?table=tblBkttZl5XmmFFB&view=vew7J3ypSr
- 统计信息接收人员：https://ycnw20znloxr.feishu.cn/wiki/QC07wNez9iSgZhk6rg7cOW2PnNb?table=tbl6brK6FcgCynAm&view=vewt6jEAWP

## 4.2 已确认字段结构（2026-02-12）
### 用餐人员配置（tblrulMIAx0vnkHu）
- `用餐人员名称` `type=20`
- `人员` `type=11`
- `餐食偏好` `type=4`
- `午餐单价` `type=2`
- `晚餐单价` `type=2`
- `启用` `type=7`

### 用餐定时配置（tblUONtouxmxvVFq）
- `开始日期` `type=5`
- `截止日期` `type=1`
- `当日餐食包含` `type=4`
- `备注` `type=1`

### 用餐记录（tblBkttZl5XmmFFB）
- `ID` `type=1005`
- `日期` `type=5`
- `用餐者` `type=11`
- `餐食类型` `type=3`
- `价格` `type=1`
- `预约状态` `type=7`

### 统计信息接收人员（tbl6brK6FcgCynAm）
- `ID` `type=1005`
- `人员` `type=11`

## 5. 配置文件说明
- `config.shared.toml`：可提交，保存 app_token、table_id、字段名映射。
- `config.local.toml`：本地私密，保存 app_id、app_secret。
- `config.shared.toml` 中 `schedule` 段用于配置发卡时间和午/晚餐截止时间。
- 加载建议：先加载 `config.shared.toml`，再用 `config.local.toml` 覆盖。

## 6. 飞书事件与回调配置（必配）
### 6.1 回调订阅方式
- 选择：`使用长连接接收事件/回调`（推荐，适用于当前自建应用）。
- 飞书后台路径：`开发配置 > 事件与回调`。

### 6.2 需要添加的事件
- `im.message.receive_v1`：接收用户给机器人发的文本消息（如 `订餐`）。

### 6.3 需要添加的回调
- `card.action.trigger`：接收卡片按钮点击并同步返回 `toast`/更新后的卡片。

### 6.4 不要添加的旧回调
- `card.action.trigger_v1`：旧版协议，不用于当前实现。

### 6.5 生效要求
- 每次修改“事件与回调”配置后，都要创建并发布新版本，否则配置不会生效。
- 若点击卡片报 `200340`，优先检查：回调订阅方式、`card.action.trigger` 是否已添加、应用版本是否已发布。

## 7. 当前实现进度（第一版）
- 已完成阶段 1~4：工程骨架、配置合并校验、飞书客户端封装、字段名动态解析、业务读模型。
- 已完成阶段 5~7 的首版：预约卡片发送、回调更新、午晚餐统计定时发送。
- 已接入飞书长连接事件：`im.message.receive_v1` 和 `card.action.trigger`（新卡片回调）。
- 当前保留项：联调验证、复杂异常场景回归、上线运维细化。

## 8. 技术方案
- 事件接收：飞书长连接（WebSocket）模式。
- `im.message.receive_v1`：使用 `asyncio` 协程调度异步处理，避免阻塞长连接主处理线程。
- `card.action.trigger`：同步处理并在 3 秒内返回 `toast` / 更新后的卡片。
- 消息发送：飞书 IM 新版卡片（JSON `schema=2.0`）。
- 数据访问：Bitable OpenAPI（records / fields）。
- 调度策略：进程内定时任务 + 截止时间判定。
- 数据一致性：写入前按“日期+人员+餐食类型”幂等检查。

## 9. 运行方式
- 配置校验：`uv run python main.py --check`
- 单次发送今日卡片：`uv run python main.py --send-today`
- 单次发送指定日期卡片：`uv run python main.py --send-date 2026-02-14`
- 常驻运行（长连接 + 定时任务）：`uv run python main.py`
- 测试模式（启用虚拟时间）：`uv run python main.py --test-mode --test-now 2026-02-13T09:00`
- 测试模式说明：
- `--test-mode` 会禁用进程内定时任务，仅保留长连接回调联调，避免误触发正式定时发送。
- `--test-now` 用于模拟“当前时间”，可反复调整以验证截止前/截止后逻辑。
- 不传 `--test-now` 时，截止判断仍使用真实系统时间。
- 用户给机器人发 `订餐` 可触发给本人发今日预约卡片。
- 真实环境联调手册：`docs/飞书真实环境联调手册.md`

## 10. 验收标准
- 每日按规则发卡，无重复、无漏发。
- 截止时间前可改、截止后不可改。
- 卡片按钮提交可正确反映到“用餐记录”表。
- 每餐截止后统计人数正确，并可发送到接收人。
- 表字段改名后，仅修改 `config.shared.toml` 可恢复运行。

## 11. 详细开发计划
### 阶段 1：工程骨架与配置加载
- 建立项目目录：`src/`、`services/`、`domain/`、`adapters/`。
- 实现配置加载器：合并 `config.shared.toml` + `config.local.toml`。
- 启动时做配置校验（必填项、重复项、字段名空值）。

### 阶段 2：飞书客户端与鉴权
- 封装 token 管理：自动获取和刷新 tenant_access_token。
- 封装 Bitable API 客户端（fields/list、records/list、create、update）。
- 封装 IM 客户端（发送卡片、发送文本统计）。

### 阶段 3：字段名动态解析
- 启动时拉取四张表 fields。
- 按 `config.shared.toml` 的字段名映射生成 runtime field_id 映射。
- 校验字段唯一性与类型，不通过则启动失败并输出明确错误。

### 阶段 4：业务读模型
- 读取并构建：人员配置模型、定时配置模型、统计接收人模型。
- 实现日期决策器：默认规则 + 覆盖规则优先级。
- 产出当天发送计划（不发/发午餐/发晚餐/发两餐）。

### 阶段 5：预约卡片发送与落库
- 按计划给启用用户发卡。
- 依据默认偏好初始化记录。
- 同步创建用餐记录（幂等）。

### 阶段 6：卡片回调处理
- 处理卡片按钮回调事件。
- 在截止时间内执行更新；超过截止时间拒绝修改并返回提示。
- 更新策略：通过“预约状态”字段切换勾选状态，勾选则创建或修正记录。

### 阶段 7：餐次统计任务
- 为午餐/晚餐分别建立截止后统计任务。
- 聚合可用记录并计算人数。
- 向统计接收人发送消息。

### 阶段 8：测试与回归
- 单元测试：日期决策、字段映射、幂等写入、截止判断。
- 集成测试：对接飞书沙箱/测试表进行全流程验证。
- 回归清单：改字段名、改表 ID、跨天任务、重复事件。

### 阶段 9：上线与运维
- 增加结构化日志与错误告警。
- 输出运维手册：常见错误码、配置变更流程、排障步骤。
- 设定发布流程：灰度验证 -> 全量启用。
