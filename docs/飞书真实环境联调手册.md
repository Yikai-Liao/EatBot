# 飞书真实环境联调手册（测试环境）

## 1. 目标
- 在真实飞书应用 + 真实多维表格上，验证 EatBot 的核心链路。
- 当前环境是测试环境，可直接改表数据，不需要保守操作。

## 2. 协作分工
- 你负责飞书侧操作：开权限、发消息、点卡片、改表数据。
- 我负责程序侧操作：启动服务、执行命令、看日志、定位问题、修复代码。

## 3. 联调前检查
### 3.1 你需要确认
- 机器人应用已启用长连接能力。
- 事件订阅已开启：`im.message.receive_v1`、`card.action.trigger`。
- 机器人可给目标用户发消息（至少包含你自己）。
- 多维表格权限已开通，应用可读写以下四张表：
- `用餐人员配置`
- `用餐定时配置`
- `用餐记录`
- `统计信息接收人员`

### 3.2 我会执行
```bash
uv run python main.py --check
```
判定标准：输出 `配置与字段映射校验通过` 和 `校验成功`。

## 4. 测试数据准备（你执行）
### 4.1 用餐人员配置
- 至少准备 2 条启用用户。
- 每条要有：`人员`、`餐食偏好`、`午餐单价`、`晚餐单价`、`启用=true`。

### 4.2 用餐定时配置
- 先清空影响当天的规则，便于走默认规则。
- 后续再新增规则验证“配置优先级覆盖默认规则”。

### 4.3 统计信息接收人员
- 至少 1 条有效 `人员`，否则统计消息不会发给任何人。

### 4.4 用餐记录
- 允许先清空，用于观察系统新写入的数据。

## 5. 联调执行顺序
## 5.1 用例 A：单次发卡（不依赖定时）
你配合：不需要额外操作。
我执行：
```bash
uv run python main.py --send-today
```
你验证：
- 启用用户收到卡片。
- 卡片文案中的默认偏好和 `用餐人员配置.餐食偏好` 一致。
- `用餐记录` 已按默认偏好写入（这是当前设计）。

## 5.2 用例 B：消息触发发卡
我先常驻启动：
```bash
uv run python main.py
```
你配合：给机器人私聊发送 `订餐`。
你验证：你本人收到当日预约卡片。

## 5.3 用例 C：卡片回调更新记录
你配合：在卡片中点击“午餐/晚餐”按钮切换状态。
你验证：
- 按钮高亮状态随点击切换。
- `用餐记录` 同步为当前选择状态。
- 卡片返回 toast `预约已更新`。

## 5.4 用例 D：截止时间拦截
你配合：把 `config.shared.toml` 的 `schedule.lunch_cutoff` 或 `schedule.dinner_cutoff` 暂时改成当前时间之前。
我重启服务后，你再次提交该餐次。
你验证：
- 提交被拒绝。
- 卡片 toast 显示 `已过截止时间`。

## 5.5 用例 E：统计发送
你配合：确保 `统计信息接收人员` 至少有 1 个人员。
你配合：把 `schedule` 截止时间临时改成最近 1~2 分钟，便于快速触发。
我重启服务并等待触发。
你验证：接收人收到 `YYYY-MM-DD 午餐/晚餐 预约人数: N`。

## 5.6 用例 F：日期规则优先级
你配合：在 `用餐定时配置` 增加覆盖当天的规则，仅含 `午餐`（或仅 `晚餐`）。
我执行：
```bash
uv run python main.py --send-today
```
你验证：仅发送规则允许的餐次。

## 6. 联调记录模板
每次反馈给我按这个格式即可：
- 用例：A/B/C/D/E/F
- 操作时间：`YYYY-MM-DD HH:mm`
- 你做了什么：
- 实际结果：
- 期望结果：
- 附件：截图（卡片、表格变更、报错提示）

## 7. 常见问题快速定位
- 收不到卡片：先确认机器人是否能给该用户发消息、该用户是否 `启用=true`。
- 有卡片但点了没反应：优先检查是否订阅了 `card.action.trigger`。
- `--check` 失败：通常是字段名改了或表权限缺失。
- 统计不发：通常是 `统计信息接收人员` 没有有效 `人员` 值。

## 8. 建议联调节奏
- 第 1 轮：A + C（先打通主链路）。
- 第 2 轮：B + D（验证事件与截止控制）。
- 第 3 轮：E + F（验证统计和规则覆盖）。
- 每一轮通过后再改代码，避免一次改太多难定位。
